var PermissionsTree=function(e){return function(){function t(e){a.jstree("select_node",e,!0);var n=a.jstree("get_parent",e);n&&t(n)}var a;return{init:function(n){(a=n).jstree({types:{default:{icon:"fa fa-folder m--font-warning"},file:{icon:"fa fa-file  m--font-warning"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},plugins:["checkbox","types"]}),a.on("changed.jstree",function(n,s){if(s.node){var i;s.node.state.selected?(t(a.jstree("get_parent",s.node)),i=e.makeArray(a.jstree("get_children_dom",s.node)),a.jstree("select_node",i)):(i=e.makeArray(a.jstree("get_children_dom",s.node)),a.jstree("deselect_node",i))}})},getSelectedPermissionNames:function(){for(var e=[],t=a.jstree("get_selected",!0),n=0;n<t.length;n++)e.push(t[n].id);return e}}}}(jQuery),OrganizationTree=function(e){return function(){function t(){var t=!1;e("#OrganizationTreeFilter").keyup(function(){t&&clearTimeout(t),t=setTimeout(function(){var t=e("#OrganizationTreeFilter").val();n.jstree(!0).search(t)},250)})}function a(e){n.jstree("select_node",e,!0);var t=n.jstree("get_parent",e);t&&a(t)}var n;return{init:function(s){(n=s).jstree({types:{default:{icon:"fa fa-folder m--font-warning"},file:{icon:"fa fa-file  m--font-warning"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},search:{show_only_matches:!0},plugins:["checkbox","types","search"]}),n.on("changed.jstree",function(t,s){if(s.node){var i;s.node.state.selected?(a(n.jstree("get_parent",s.node)),i=e.makeArray(n.jstree("get_children_dom",s.node)),n.jstree("select_node",i)):(i=e.makeArray(n.jstree("get_children_dom",s.node)),n.jstree("deselect_node",i))}}),t()},getSelectedOrganizations:function(){for(var e=[],t=n.jstree("get_selected",!0),a=0;a<t.length;a++)e.push(t[a].id);return e}}}}(jQuery);!function(e){app.modals.CreateOrEditUserModal=function(){function t(){var t=[];return a.getModal().find(".user-role-checkbox-list input[type=checkbox]").each(function(){e(this).is(":checked")&&t.push(e(this).attr("name"))}),t}var a,n,s=abp.services.app.user,i=null,r=new app.PasswordComplexityHelper;this.init=function(s){a=s,(n=new OrganizationTree).init(a.getModal().find(".organization-tree")),(i=a.getModal().find("form[name=UserInformationsForm]")).validate();var o=a.getModal().find("input[name=Password],input[name=PasswordRepeat]"),l=o.closest(".form-group");r.setPasswordComplexityRules(o,window.passwordComplexitySetting),e("#EditUser_SetRandomPassword").change(function(){e(this).is(":checked")?(l.slideUp("fast"),a.getArgs().id||o.removeAttr("required")):(l.slideDown("fast"),a.getArgs().id||o.attr("required","required"))}),a.getModal().find(".user-role-checkbox-list input[type=checkbox]").change(function(){e("#assigned-role-count").text(t().length)}),a.getModal().find("[data-toggle=tooltip]").tooltip()},this.save=function(){if(i.valid()){var e=t(),r=i.serializeFormToObject();r.SetRandomPassword&&(r.Password=null),a.setBusy(!0),s.createOrUpdateUser({user:r,assignedRoleNames:e,sendActivationEmail:r.SendActivationEmail,SetRandomPassword:r.SetRandomPassword,organizationUnits:n.getSelectedOrganizations()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),a.close(),abp.event.trigger("app.createOrEditUserModalSaved")}).always(function(){a.setBusy(!1)})}}}}(jQuery),app.modals.UserPermissionsModal=function(){function e(){t.setBusy(!0),n.resetUserSpecificPermissions({id:t.getArgs().id}).done(function(){abp.notify.info(app.localize("ResetSuccessfully")),t.getModal().on("hidden.bs.modal",function(e){t.reopen()}),t.close()}).always(function(){t.setBusy(!1)})}var t,a,n=abp.services.app.user;this.init=function(n){t=n,(a=new PermissionsTree).init(t.getModal().find(".permission-tree")),t.getModal().find("[data-toggle=tooltip]").tooltip(),t.getModal().find(".reset-permissions-button").click(function(){e()})},this.save=function(){t.setBusy(!0),n.updateUserPermissions({id:t.getArgs().id,grantedPermissionNames:a.getSelectedPermissionNames()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),t.close()}).always(function(){t.setBusy(!1)})}},$(function(){function e(){o.ajax.reload()}function t(t){t.userName!==app.consts.userManagement.defaultAdminUserName?abp.message.confirm(app.localize("UserDeleteWarningMessage",t.userName),function(a){a&&n.deleteUser({id:t.id}).done(function(){e(!0),abp.notify.success(app.localize("SuccessfullyDeleted"))})}):abp.message.warn(app.localize("{0}UserCannotBeDeleted",app.consts.userManagement.defaultAdminUserName))}var a=$("#UsersTable"),n=abp.services.app.user,s={create:abp.auth.hasPermission("Pages.Administration.Users.Create"),edit:abp.auth.hasPermission("Pages.Administration.Users.Edit"),changePermissions:abp.auth.hasPermission("Pages.Administration.Users.ChangePermissions"),impersonation:abp.auth.hasPermission("Pages.Administration.Users.Impersonation"),delete:abp.auth.hasPermission("Pages.Administration.Users.Delete")},i=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Users/CreateOrEditModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Users/_CreateOrEditModal.js",modalClass:"CreateOrEditUserModal"}),r=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Users/PermissionsModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Users/_PermissionsModal.js",modalClass:"UserPermissionsModal"}),o=a.DataTable({paging:!0,serverSide:!0,processing:!0,listAction:{ajaxFunction:n.getUsers,inputFilter:function(){return{filter:$("#UsersTableFilter").val(),permission:$("#PermissionSelectionCombo").val(),role:$("#RoleSelectionCombo").val()}}},columnDefs:[{targets:0,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{cssClass:"btn btn-brand dropdown-toggle",text:'<i class="fa fa-cog"></i> '+app.localize("Actions")+' <span class="caret"></span>',items:[{text:app.localize("LoginAsThisUser"),visible:function(e){return s.impersonation&&e.record.id!==abp.session.userId},action:function(e){abp.ajax({url:abp.appPath+"Account/Impersonate",data:JSON.stringify({tenantId:abp.session.tenantId,userId:e.record.id})})}},{text:app.localize("Edit"),visible:function(){return s.edit},action:function(e){i.open({id:e.record.id})}},{text:app.localize("Permissions"),visible:function(){return s.changePermissions},action:function(e){r.open({id:e.record.id})}},{text:app.localize("Unlock"),visible:function(){return s.changePermissions},action:function(e){n.unlockUser({id:e.record.id}).done(function(){abp.notify.success(app.localize("UnlockedTheUser",e.record.userName))})}},{text:app.localize("Delete"),visible:function(){return s.delete},action:function(e){t(e.record)}}]}},{targets:1,data:"userName",render:function(e,t,a,n){var s=$("<span/>");if(a.profilePictureId){var i="/Profile/GetProfilePictureById?id="+a.profilePictureId,r=$("<a/>").attr("href",i).attr("target","_blank"),o=$("<img/>").addClass("img-circle").attr("src",i);r.append(o),s.append(r)}return s.append(e),s[0].outerHTML}},{targets:2,data:"name"},{targets:3,data:"surname"},{targets:4,data:"roles",render:function(e){for(var t="",a=0;a<e.length;a++)t.length&&(t+=", "),t+=e[a].roleName;return t}},{targets:5,data:"emailAddress"},{targets:6,data:"isEmailConfirmed",render:function(e){return e?'<span class="label label-success">'+app.localize("Yes")+"</span>":'<span class="label label-default">'+app.localize("No")+"</span>"}},{targets:7,data:"isActive",render:function(e){return e?'<span class="label label-success">'+app.localize("Yes")+"</span>":'<span class="label label-default">'+app.localize("No")+"</span>"}},{targets:8,data:"lastLoginTime",render:function(e){return e?moment(e).format("L"):""}},{targets:9,data:"creationTime",render:function(e){return moment(e).format("L")}}]});$("#ShowAdvancedFiltersSpan").click(function(){$("#ShowAdvancedFiltersSpan").hide(),$("#HideAdvancedFiltersSpan").show(),$("#AdvacedAuditFiltersArea").slideDown()}),$("#HideAdvancedFiltersSpan").click(function(){$("#HideAdvancedFiltersSpan").hide(),$("#ShowAdvancedFiltersSpan").show(),$("#AdvacedAuditFiltersArea").slideUp()}),$("#CreateNewUserButton").click(function(){i.open()}),$("#ExportUsersToExcelButton").click(function(){n.getUsersToExcel({}).done(function(e){app.downloadTempFile(e)})}),$("#GetUsersButton, #RefreshUserListButton").click(function(t){t.preventDefault(),e()}),$("#UsersTableFilter").on("keydown",function(t){13===t.keyCode&&(t.preventDefault(),e())}),abp.event.on("app.createOrEditUserModalSaved",function(){e()}),$("#UsersTableFilter").focus()});