var FeaturesTree=function(e){return function(){function t(e){n.jstree("select_node",e,!0);var a=n.jstree("get_parent",e);a&&t(a)}function a(e,t){if(!e||!e.inputType||!e.inputType.validator)return!0;var a=e.inputType.validator;if("STRING"==a.name){if(void 0==t||null==t)return a.allowNull;if("string"!=typeof t)return!1;if(a.minLength>0&&t.length<a.minLength)return!1;if(a.maxLength>0&&t.length>a.maxLength)return!1;if(a.regularExpression)return new RegExp(a.regularExpression).test(t)}else if("NUMERIC"==a.name){var n=parseInt(t);if(isNaN(n))return!1;if(a.minValue>n)return!1;var i=a.maxValue;if(i>0&&n>i)return!1}return!0}var n;return{init:function(i){function r(){n.find(".jstree-node").each(function(){var t=e(this),n=t.find(".jstree-anchor"),i=JSON.parse(t.attr("data-feature")),r=t.attr("data-feature-value");if(i&&i.inputType)if("CHECKBOX"==i.inputType.name);else if("SINGLE_LINE_STRING"==i.inputType.name){if(!t.find(".feature-tree-textbox").length){n.find(".jstree-checkbox").hide();var o="text";i.inputType.validator&&"NUMERIC"==i.inputType.validator.name&&(o="number");var s=e('<input class="feature-tree-textbox" type="'+o+'" />').val(r);"number"==o?(s.attr("min",i.inputType.validator.minValue),s.attr("max",i.inputType.validator.maxValue)):i.inputType.validator&&"STRING"==i.inputType.validator.name&&(i.inputType.validator.maxLength>0&&s.attr("maxlength",i.inputType.validator.maxLength),i.inputType.validator.minLength>0&&s.attr("required","required"),i.inputType.validator.regularExpression&&s.attr("pattern",i.inputType.validator.regularExpression)),s.on("input propertychange paste",function(){a(i,s.val())?(t.attr("data-feature-value",s.val()),s.removeClass("feature-tree-textbox-invalid")):s.addClass("feature-tree-textbox-invalid")}),s.appendTo(t)}}else if("COMBOBOX"==i.inputType.name&&!t.find(".feature-tree-combobox").length){n.find(".jstree-checkbox").hide();var d=e('<select class="feature-tree-combobox" />');_.each(i.inputType.itemSource.items,function(t){e("<option></option>").attr("value",t.value).text(t.displayText).appendTo(d)}),d.val(r).on("change",function(){t.attr("data-feature-value",d.val())}).appendTo(t)}})}(n=i).on("ready.jstree",function(){r()}).on("redraw.jstree",function(){r()}).on("after_open.jstree",function(){r()}).on("create_node.jstree",function(){r()}).on("changed.jstree",function(a,i){if(i.node){var r;i.node.state.selected?(t(n.jstree("get_parent",i.node)),r=e.makeArray(n.jstree("get_children_dom",i.node)),n.jstree("select_node",r)):(r=e.makeArray(n.jstree("get_children_dom",i.node)),n.jstree("deselect_node",r))}}).jstree({types:{default:{icon:"fa fa-folder m--font-warning"},file:{icon:"fa fa-file  m--font-warning"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},plugins:["checkbox","types"]})},getFeatureValues:function(){var t=[];return n.find(".jstree-node").each(function(){var a=e(this),i=JSON.parse(a.attr("data-feature"));i.inputType&&"CHECKBOX"!=i.inputType.name?t.push({name:i.name,value:a.attr("data-feature-value")}):t.push({name:i.name,value:n.jstree("is_checked",a)?"true":"false"})}),t},isValid:function(){return n.find(".feature-tree-textbox-invalid").length<=0}}}}(jQuery);!function(e){e.validator.addMethod("tenancyNameRegex",function(e,t,a){return a.test(e)},app.localize("TenantName_Regex_Description")),app.modals.CreateTenantModal=function(){var t,a=abp.services.app.tenant,n=null,i=new app.PasswordComplexityHelper;this.init=function(a){function r(){u.is(":checked")?(l.slideUp("fast"),f.removeAttr("required")):(l.slideDown("fast"),f.attr("required","required"))}var o=(t=a).getModal();(n=o.find("form[name=TenantInformationsForm]")).validate({rules:{TenancyName:{tenancyNameRegex:new RegExp(n.find("input[name=TenancyName]").attr("regex"))}}});var s=o.find("input[name=AdminPassword],input[name=AdminPasswordRepeat]"),d=s.closest(".form-group");i.setPasswordComplexityRules(s,window.passwordComplexitySetting),e("#CreateTenant_SetRandomPassword").change(function(){e(this).is(":checked")?(d.slideUp("fast"),s.removeAttr("required")):(d.slideDown("fast"),s.attr("required","required"))});var c=o.find("input[name=ConnectionString]"),p=c.closest(".form-group");e("#CreateTenant_UseHostDb").change(function(){e(this).is(":checked")?(p.slideUp("fast"),c.removeAttr("required")):(p.slideDown("fast"),c.attr("required","required"))}),o.find(".date-time-picker").datetimepicker({language:abp.localization.currentLanguage.name,minView:"month",maxView:"year",format:moment.defaultFormat.toLowerCase().substr(0,10)});var l=o.find("input[name=SubscriptionEndDateUtc]").parent("div"),u=o.find("#CreateTenant_IsUnlimited"),f=o.find("input[name=SubscriptionEndDateUtc]");u.change(function(){r()}),r();var m=o.find("#EditionId"),v=o.find("#CreateTenant_IsInTrialPeriod");m.change(function(){var t="True"===e("option:selected",this).attr("data-isfree"),a=e("option:selected",this).val();t?v.closest("div").slideUp("fast"):v.closest("div").slideDown("fast"),a<=0?o.find(".subscription-component").slideUp("fast"):o.find(".subscription-component").slideDown("fast")}),m.trigger("change")},this.save=function(){if(n.valid()){var i=n.serializeFormToObject();e("#CreateTenant_IsUnlimited").is(":visible")&&!e("#CreateTenant_IsUnlimited").is(":checked")?i.SubscriptionEndDateUtc=moment(e(".date-time-picker").datadatetimepicker("getDate")).format("YYYY-MM-DDTHH:mm:ss")+"Z":i.SubscriptionEndDateUtc=null,i.SetRandomPassword&&(i.Password=null),i.UseHostDb&&(i.ConnectionString=null),t.setBusy(!0),a.createTenant(i).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),t.close(),abp.event.trigger("app.createTenantModalSaved")}).always(function(){t.setBusy(!1)})}}}}(jQuery);var EditTenantModal=function(e){app.modals.EditTenantModal=function(){var t,a=abp.services.app.tenant,n=null;this.init=function(a){function i(){s.is(":checked")?o.slideUp("fast"):o.slideDown("fast")}var r=(t=a).getModal();(n=r.find("form[name=TenantInformationsForm]")).validate(),r.find(".date-time-picker").datetimepicker({language:abp.localization.currentLanguage.name,minView:"month",maxView:"year",format:moment.defaultFormat.toLowerCase().substr(0,10)});var o=r.find("input[name=SubscriptionEndDateUtc]").parent("div"),s=r.find("#CreateTenant_IsUnlimited");s.change(function(){i()}),i();var d=r.find("#EditionId"),c=r.find("#EditTenant_IsInTrialPeriod");d.change(function(){var t="True"===e("option:selected",this).attr("data-isfree"),a=e("option:selected",this).val();t?c.closest("div").slideUp("fast"):c.closest("div").slideDown("fast"),a<=0?r.find(".subscription-component").slideUp("fast"):r.find(".subscription-component").slideDown("fast")}),d.trigger("change")},this.save=function(){if(n.valid()){var i=n.serializeFormToObject();e("#CreateTenant_IsUnlimited").is(":visible")&&!e("#CreateTenant_IsUnlimited").is(":checked")?i.SubscriptionEndDateUtc=moment(e(".date-time-picker").datetimepicker("getDate")).format("YYYY-MM-DDTHH:mm:ss")+"Z":i.SubscriptionEndDateUtc=null,t.setBusy(!0),a.updateTenant(i).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),t.close(),abp.event.trigger("app.editTenantModalSaved")}).always(function(){t.setBusy(!1)})}}}}(jQuery);app.modals.TenantFeaturesModal=function(){function e(){t.setBusy(!0),n.resetTenantSpecificFeatures({id:t.getArgs().id}).done(function(){abp.notify.info(app.localize("ResetSuccessfully")),t.getModal().on("hidden.bs.modal",function(e){t.reopen()}),t.close()}).always(function(){t.setBusy(!1)})}var t,a,n=abp.services.app.tenant;this.init=function(n){t=n,(a=new FeaturesTree).init(t.getModal().find(".feature-tree")),t.getModal().find("[data-toggle=tooltip]").tooltip(),t.getModal().find(".reset-features-button").click(function(){e()})},this.save=function(){a.isValid()?(t.setBusy(!0),n.updateTenantFeatures({id:t.getArgs().id,featureValues:a.getFeatureValues()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),t.close()}).always(function(){t.setBusy(!1)})):abp.message.warn(app.localize("InvalidFeaturesWarning"))}},$(function(){function e(){D.ajax.reload()}function t(t){abp.message.confirm(app.localize("TenantDeleteWarningMessage",t.tenancyName),function(n){n&&a.deleteTenant({id:t.id}).done(function(){e(),abp.notify.success(app.localize("SuccessfullyDeleted"))})})}var a=abp.services.app.tenant,n=$("#TenantsTable"),i=$("#TenantsTableFilter"),r=$("#TenantsFormFilter"),o=$("#TenantsTable_SubscriptionEndDateRangeActive"),s=r.find("input[name='SubscriptionEndDateRange']"),d=$("#TenantsTable_CreationDateRangeActive"),c=r.find("input[name='CreationDateRange']"),p=r.find("button[name='RefreshButton']"),l=r.find("#EditionDropdown"),u={create:abp.auth.hasPermission("Pages.Tenants.Create"),edit:abp.auth.hasPermission("Pages.Tenants.Edit"),changeFeatures:abp.auth.hasPermission("Pages.Tenants.ChangeFeatures"),impersonation:abp.auth.hasPermission("Pages.Tenants.Impersonation"),delete:abp.auth.hasPermission("Pages.Tenants.Delete")},f={creationDateStart:$.url("?creationDateStart"),creationDateEnd:$.url("?creationDateEnd"),subscriptionEndDateStart:$.url("?subscriptionEndDateStart"),subscriptionEndDateEnd:$.url("?subscriptionEndDateEnd")},m={startDate:f.subscriptionEndDateStart?moment(f.subscriptionEndDateStart):moment().startOf("day"),endDate:f.subscriptionEndDateEnd?moment(f.subscriptionEndDateEnd):moment().add(30,"days").endOf("day")},v={startDate:f.creationDateStart?moment(f.creationDateStart):moment().add(-7,"days").startOf("day"),endDate:f.creationDateEnd?moment(f.creationDateEnd):moment().endOf("day")};s.daterangepicker($.extend(!0,app.createDateRangePickerOptions({allowFutureDate:!0}),m),function(e,t,a){m.startDate=e,m.endDate=t}),c.daterangepicker($.extend(!0,app.createDateRangePickerOptions(),v),function(e,t,a){v.startDate=e,v.endDate=t});var g=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Tenants/CreateModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Tenants/_CreateModal.js",modalClass:"CreateTenantModal"}),b=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Tenants/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Tenants/_EditModal.js",modalClass:"EditTenantModal"}),T=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Tenants/FeaturesModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Tenants/_FeaturesModal.js",modalClass:"TenantFeaturesModal"}),h=app.modals.LookupModal.create({title:app.localize("SelectAUser"),serviceMethod:abp.services.app.commonLookup.findUsers}),y=function(){var e=l.find(":selected").val(),t={filter:i.val(),editionId:e,editionIdSpecified:"-1"!==e};return d.prop("checked")&&(t.creationDateStart=v.startDate,t.creationDateEnd=v.endDate),o.prop("checked")&&(t.subscriptionEndDateStart=m.startDate,t.subscriptionEndDateEnd=m.endDate),t},D=n.DataTable({paging:!0,serverSide:!0,processing:!0,listAction:{ajaxFunction:a.getTenants,inputFilter:function(){return y()}},columnDefs:[{targets:0,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{cssClass:"btn btn-xs btn-primary blue",text:'<i class="fa fa-cog"></i> '+app.localize("Actions")+' <span class="caret"></span>',items:[{text:app.localize("LoginAsThisTenant"),visible:function(){return u.impersonation},action:function(e){h.open({extraFilters:{tenantId:e.record.id},title:app.localize("SelectAUser")},function(t){abp.ajax({url:abp.appPath+"Account/Impersonate",data:JSON.stringify({tenantId:e.record.id,userId:parseInt(t.value)}),success:function(){app.supportsTenancyNameInUrl||abp.multiTenancy.setTenantIdCookie(e.record.id)}})})}},{text:app.localize("Edit"),visible:function(){return u.edit},action:function(e){b.open({id:e.record.id})}},{text:app.localize("Features"),visible:function(){return u.changeFeatures},action:function(e){T.open({id:e.record.id})}},{text:app.localize("Delete"),visible:function(){return u.delete},action:function(e){t(e.record)}},{text:app.localize("Unlock"),action:function(e){a.unlockTenantAdmin({id:e.record.id}).done(function(){abp.notify.success(app.localize("UnlockedTenandAdmin",e.record.name))})}}]}},{targets:1,data:"tenancyName"},{targets:2,data:"name"},{targets:3,data:"editionDisplayName"},{targets:4,data:"subscriptionEndDateUtc",render:function(e){return e?moment(e).format("L"):""}},{targets:5,data:"isActive",render:function(e){return e?'<span class="label label-success">'+app.localize("Yes")+"</span>":'<span class="label label-default">'+app.localize("No")+"</span>"}},{targets:6,data:"creationTime",render:function(e){return moment(e).format("L")}}]});$("#CreateNewTenantButton").click(function(){g.open()}),$("#GetTenantsButton").click(function(t){t.preventDefault(),e()}),abp.event.on("app.editTenantModalSaved",function(){e(!0)}),abp.event.on("app.createTenantModalSaved",function(){e(!0)}),o.change(function(){s.prop("disabled",!$(this).prop("checked"))}),f.subscriptionEndDateStart||f.subscriptionEndDateEnd?o.prop("checked",!0):s.prop("disabled",!0),d.change(function(){c.prop("disabled",!$(this).prop("checked"))}),f.creationDateStart||f.creationDateEnd?d.prop("checked",!0):c.prop("disabled",!0),p.click(function(t){t.preventDefault(),e()}),i.focus()});