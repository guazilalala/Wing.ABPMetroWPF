var PermissionsTree=function(e){return function(){function t(e){a.jstree("select_node",e,!0);var i=a.jstree("get_parent",e);i&&t(i)}var a;return{init:function(i){(a=i).jstree({types:{default:{icon:"fa fa-folder m--font-warning"},file:{icon:"fa fa-file  m--font-warning"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},plugins:["checkbox","types"]}),a.on("changed.jstree",function(i,n){if(n.node){var o;n.node.state.selected?(t(a.jstree("get_parent",n.node)),o=e.makeArray(a.jstree("get_children_dom",n.node)),a.jstree("select_node",o)):(o=e.makeArray(a.jstree("get_children_dom",n.node)),a.jstree("deselect_node",o))}})},getSelectedPermissionNames:function(){for(var e=[],t=a.jstree("get_selected",!0),i=0;i<t.length;i++)e.push(t[i].id);return e}}}}(jQuery);app.modals.CreateOrEditRoleModal=function(){var e,t,a=abp.services.app.role,i=null;this.init=function(a){e=a,(t=new PermissionsTree).init(e.getModal().find(".permission-tree")),(i=e.getModal().find("form[name=RoleInformationsForm]")).validate({ignore:""})},this.save=function(){if(i.valid()){var n=i.serializeFormToObject();e.setBusy(!0),a.createOrUpdateRole({role:n,grantedPermissionNames:t.getSelectedPermissionNames()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),e.close(),abp.event.trigger("app.createOrEditRoleModalSaved")}).always(function(){e.setBusy(!1)})}}},$(function(){function e(e){abp.message.confirm(app.localize("RoleDeleteWarningMessage",e.displayName),function(a){a&&i.deleteRole({id:e.id}).done(function(){t(),abp.notify.success(app.localize("SuccessfullyDeleted"))})})}function t(){r.ajax.reload()}var a=$("#RolesTable"),i=abp.services.app.role,n={create:abp.auth.hasPermission("Pages.Administration.Roles.Create"),edit:abp.auth.hasPermission("Pages.Administration.Roles.Edit"),delete:abp.auth.hasPermission("Pages.Administration.Roles.Delete")},o=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Roles/CreateOrEditModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Roles/_CreateOrEditModal.js",modalClass:"CreateOrEditRoleModal"}),r=a.DataTable({paging:!1,serverSide:!1,processing:!1,drawCallback:function(e){$("[data-toggle=m-tooltip]").tooltip()},listAction:{ajaxFunction:i.getRoles,inputFilter:function(){return{permission:$("#PermissionSelectionCombo").val()}}},columnDefs:[{targets:0,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{cssClass:"btn btn-xs btn-primary blue",text:'<i class="fa fa-cog"></i> '+app.localize("Actions")+' <span class="caret"></span>',items:[{text:app.localize("Edit"),visible:function(){return n.edit},action:function(e){o.open({id:e.record.id})}},{text:app.localize("Delete"),visible:function(e){return!e.record.isStatic&&n.delete},action:function(t){e(t.record)}}]}},{targets:1,data:"displayName",render:function(e,t,a,i){var n=$("<span/>");return n.append(e+" &nbsp;"),a.isStatic&&n.append($("<span/>").addClass("m-badge m-badge--brand m-badge--wide").attr("data-toggle","m-tooltip").attr("title",app.localize("StaticRole_Tooltip")).attr("data-placement","top").text(app.localize("Static")).css("margin-right","5px")),a.isDefault&&n.append($("<span/>").addClass("m-badge m-badge--metal m-badge--wide").attr("data-toggle","m-tooltip").attr("title",app.localize("DefaultRole_Description")).attr("data-placement","top").text(app.localize("Default")).css("margin-right","5px")),n[0].outerHTML}},{targets:2,data:"creationTime",render:function(e){return moment(e).format("L")}}]});$("#CreateNewRoleButton").click(function(){o.open()}),$("#RefreshRolesButton").click(function(e){e.preventDefault(),t()}),abp.event.on("app.createOrEditRoleModalSaved",function(){t()})});